<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Slides Viewer</title>

		<script>
			const addStyleSheet = (path) => {
				const stylesheet = document.createElement("LINK");
				stylesheet.setAttribute("rel", "stylesheet");
				stylesheet.setAttribute("type", "text/css");
				stylesheet.setAttribute("href", path);
				document.head.appendChild(stylesheet);
			}

			const urlParams = new URLSearchParams(window.location.search);
			const source = urlParams.get('source');
			const theme = urlParams.get('theme') || "kesseo";
			const hljsStyle = urlParams.get('hljs');
			
			const noSourceStylesheets = [
				"dist/home.css"
			]
			const revealStylesheets = [
				"dist/reset.css",
				"dist/reveal.css",
				`dist/theme/${theme}.css`,
			]
			if (hljsStyle) revealStylesheets.push(`https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/${hljsStyle}.min.css`)

			const stylesheets = source ? revealStylesheets : noSourceStylesheets

			stylesheets.forEach(stylesheet => addStyleSheet(stylesheet))
		</script>
		<style>.scrollable-slide {height: 800px;overflow-y: auto !important;}</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides" hidden></div>
			<div id="no-url-page">
				<!-- Shows this form if no markdown url was given in the params -->
				<div id="progress"></div>

				<div class="center">
					<div id="register">

						<i id="progressButton" class="ion-android-arrow-forward next"></i>

						<div id="inputContainer">
							<input id="inputField" required autofocus />
							<label id="inputLabel"></label>
							<div id="inputProgress"></div>
						</div>

					</div>
				</div>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			if (source) {
				const revealSettingsDefault = {
					hash: true,
					width: 1280,
					height: 800,
					controls: true,
					progress: true,
					history: true,
					center: true,
					slideNumber: true,
					disableLayout: false,
					separatorVertical: "^(\r?\n\r?\n|--$)",
					// Note that Windows uses `\r\n` instead of `\n` as its linefeed character.
					// For a regex that supports all operating systems, use `\r?\n` instead of `\n`.
					separatorNotes: urlParams.get('separatorNotes') || "^Note:",
					separator: urlParams.get('separator') || "^---$",
				}
	
				const revealSettings = urlParams
				for (var param in revealSettingsDefault) revealSettings[param] ||= revealSettingsDefault[param]

				if (source.match(/https?:\/\/[\w-]+/)) {
					revealSettings.markdown = source
				} else {
					revealSettings.markdown = `https://raw.githubusercontent.com/${source}/master/README.md`
				}

				const slidesContainer = document.querySelector('.slides')
				slidesContainer.removeAttribute('hidden')
				document.getElementById('no-url-page').remove()

				const slides = document.createElement('section')
				for (var option in revealSettings) slides.dataset[option] = revealSettings[option]
				slidesContainer.append(slides)

				// Scrollable slides if taller than 800px

				const resetSlideScrolling = (slide) => {
					slide.classList.remove('scrollable-slide');
				}

				const handleSlideScrolling = (slide) => {
					if (slide.scrollHeight >= 800) {
						slide.classList.add('scrollable-slide');
					}
				}

				Reveal.addEventListener('ready', function (event) {
					handleSlideScrolling(event.currentSlide);
				});

				Reveal.addEventListener('slidechanged', function (event) {
					if (event.previousSlide) resetSlideScrolling(event.previousSlide)
					handleSlideScrolling(event.currentSlide);
				});

				// More info about config & dependencies:
				// - https://github.com/hakimel/reveal.js#configuration
				// - https://github.com/hakimel/reveal.js#dependencies
				Reveal.initialize({
					...revealSettings,

					plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
				});
			} else {
				var questions = [
					{
						question:"Enter markdown url or GitHub repository name [username/repo]",
						pattern: /(^https?:\/\/[\w-]+|^[\w-]+\/[\w-]+$)/
					}
				]

				;(function(){

					var tTime = 100  // transition transform time from #register in ms
					var wTime = 200  // transition width time from #register in ms
					var eTime = 1000 // transition width time from inputLabel in ms

					// init
					// --------------
					var position = 0

					putQuestion()

					progressButton.addEventListener('click', validate)
					inputField.addEventListener('keyup', function(e){
						transform(0, 0) // ie hack to redraw
						if(e.keyCode == 13) validate()
					})

					// functions
					// --------------

					// load the next question
					function putQuestion() {
						inputLabel.innerHTML = questions[position].question
						inputField.value = ''
						inputField.type = questions[position].type || 'text'  
						inputField.focus()
						showCurrent()
					}
					
					// when all the questions have been answered
					function done() {
						
						// remove the box if there is no next question
						register.className = 'close'
						
						// add the h1 at the end with the welcome text
						var h1 = document.createElement('h1')
						h1.appendChild(document.createTextNode('Welcome ' + questions[0].value + '!'))
						setTimeout(function() {
							window.location.href = `/?source=${inputField.value}`;
						}, eTime)
					}

					// when submitting the current question
					function validate() {

						// set the value of the field into the array
						questions[position].value = inputField.value

						// check if the pattern matches
						if (!inputField.value.match(questions[position].pattern || /.+/)) wrong()
						else ok(function() {
							
							// set the progress of the background
							progress.style.width = ++position * 100 / questions.length + 'vw'

							// if there is a new question, hide current and load next
							if (questions[position]) hideCurrent(putQuestion)
							else hideCurrent(done)		
						})
					}

					// helper
					// --------------

					function hideCurrent(callback) {
						inputContainer.style.opacity = 0
						inputProgress.style.transition = 'none'
						inputProgress.style.width = 0
						setTimeout(callback, wTime)
					}

					function showCurrent(callback) {
						inputContainer.style.opacity = 1
						inputProgress.style.transition = ''
						inputProgress.style.width = '100%'
						setTimeout(callback, wTime)
					}

					function transform(x, y) {
						register.style.transform = 'translate(' + x + 'px ,  ' + y + 'px)'
					}

					function ok(callback) {
						register.className = ''
						setTimeout(transform, tTime * 0, 0, 10)
						setTimeout(transform, tTime * 1, 0, 0)
						setTimeout(callback,  tTime * 2)
					}

					function wrong(callback) {
						register.className = 'wrong'
						for(var i = 0; i < 6; i++) // shaking motion
							setTimeout(transform, tTime * i, (i%2*2-1)*20, 0)
						setTimeout(transform, tTime * 6, 0, 0)
						setTimeout(callback,  tTime * 7)
					}

				}())
			}
		</script>
	</body>
</html>
